<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Scanner PRO - LS1995</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #111;
    color: #fff;
    font-family: sans-serif;
    text-align: center;
  }

  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
  }

  h3 { margin-top: 10px; color: #06C755; }

  #videoContainer {
    width: 100%;
    max-width: 420px;
    aspect-ratio: 1/1;
    background: black;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    border: 2px solid #333;
  }

  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .overlay {
    position: absolute;
    inset: 0;
    border: 3px solid #06C755;
    box-sizing: border-box;
    pointer-events: none;
  }

  button {
    padding: 15px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 8px;
    border: none;
    background: #06C755;
    color: white;
    cursor: pointer;
    width: 100%;
    max-width: 420px;
    margin-top: 10px;
  }

  input {
    padding: 15px;
    border-radius: 8px;
    width: 100%;
    max-width: 420px;
    margin-top: 10px;
    font-size: 16px;
    border: 1px solid #555;
    text-align: center;
  }

  #status {
    font-size: 14px;
    color: #aaa;
    margin-top: 10px;
  }

</style>
</head>

<body>

<h3>üîç Scanner PRO</h3>
<div id="videoContainer">
  <video id="video" autoplay playsinline></video>
  <div class="overlay"></div>
</div>

<p id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...</p>

<button onclick="toggleFlash()">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡πÑ‡∏ü‡πÅ‡∏ü‡∏•‡∏ä</button>

<input type="text" id="manualInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏≠‡∏á">
<button onclick="sendManual()">‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™</button>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script type="module">

import { BrowserMultiFormatReader } from 
'https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.1/+esm';

const LIFF_ID = "2008552223-7BjGxV6G";

let codeReader = new BrowserMultiFormatReader({
  delayBetweenScanAttempts: 50,
  delayBetweenScanSuccess: 500
});

let currentStream;
let videoTrack;
let flashOn = false;

async function initLIFF() {
  await liff.init({ liffId: LIFF_ID });
  await liff.ready;
  startCamera();
}

async function startCamera() {
  try {

    // 1Ô∏è‚É£ ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö ‡πÜ ‡∏Å‡πà‡∏≠‡∏ô
    currentStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: "environment",
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    });

    const video = document.getElementById("video");
    video.srcObject = currentStream;
    video.setAttribute("playsinline", true);
    await video.play();

    videoTrack = currentStream.getVideoTracks()[0];

    // 2Ô∏è‚É£ ‡∏Ñ‡πà‡∏≠‡∏¢‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á
    const capabilities = videoTrack.getCapabilities();

    const advancedConstraints = {};

    if (capabilities.focusMode) {
      advancedConstraints.focusMode = "continuous";
    }

    if (capabilities.exposureMode) {
      advancedConstraints.exposureMode = "continuous";
    }

    if (Object.keys(advancedConstraints).length > 0) {
      await videoTrack.applyConstraints({
        advanced: [advancedConstraints]
      });
    }

    document.getElementById("status").innerText =
      "‡πÄ‡∏•‡πá‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏£‡∏≠‡∏ö";

    // 3Ô∏è‚É£ ‡πÄ‡∏£‡∏¥‡πà‡∏° decode
    codeReader.decodeFromVideoElement(video, (result, err) => {
      if (result) {
        stopCamera();
        sendToChat(result.getText());
      }
    });

  } catch (err) {

    console.error(err);

    document.getElementById("status").innerText =
      "‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á";

  }
}

function toggleFlash() {
  if (!videoTrack) return;

  const capabilities = videoTrack.getCapabilities();
  if (!capabilities.torch) {
    alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡πÅ‡∏ü‡∏•‡∏ä");
    return;
  }

  flashOn = !flashOn;
  videoTrack.applyConstraints({
    advanced: [{ torch: flashOn }]
  });
}

function stopCamera() {
  if (currentStream) {
    currentStream.getTracks().forEach(track => track.stop());
  }
}

function sendManual() {
  let val = document.getElementById('manualInput').value.trim();
  if (val) sendToChat(val);
}

function sendToChat(text) {
  document.getElementById("status").innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
  if (liff.isInClient()) {
    liff.sendMessages([{ type: 'text', text }])
      .then(() => liff.closeWindow());
  } else {
    alert(text);
  }
}

initLIFF();

</script>
</body>
</html>
