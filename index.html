<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>1D Scanner PRO</title>

<style>
html, body {
  margin:0;
  padding:0;
  background:#111;
  color:#fff;
  font-family:sans-serif;
  text-align:center;
}

h3 { color:#06C755; margin:10px 0; }

#reader {
  width:100%;
  max-width:420px;
  height:220px;
  margin:auto;
  border:2px solid #333;
  border-radius:12px;
  overflow:hidden;
}

.controls {
  width:95%;
  max-width:420px;
  margin:10px auto;
}

button, select, input[type=range] {
  width:100%;
  padding:12px;
  margin-bottom:8px;
  font-size:15px;
  border-radius:8px;
  border:none;
}

button { background:#06C755; color:#fff; font-weight:bold; }

input[type=text] {
  text-align:center;
  border:1px solid #555;
}

#status { font-size:14px; color:#aaa; margin:8px; }
</style>
</head>

<body>

<h3>üîç ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>

<div id="reader"></div>
<div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

<div class="controls">
  <select id="cameraSelect"></select>
  <button onclick="toggleTorch()">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏â‡∏≤‡∏¢</button>
  <label>‡∏ã‡∏π‡∏°</label>
  <input type="range" id="zoomRange" min="1" max="3" step="0.1" value="1">
  <button onclick="restartScanner()">‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>

  <input type="text" id="manualInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏≠‡∏á">
  <button onclick="sendManual()">‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™</button>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const LIFF_ID = "2008552223-7BjGxV6G";
let scanner;
let currentCameraId = null;
let torchOn = false;

async function init() {
  await liff.init({ liffId: LIFF_ID });
  await liff.ready;
  loadCameras();
}

async function loadCameras() {
  const devices = await Html5Qrcode.getCameras();
  const select = document.getElementById("cameraSelect");
  select.innerHTML = "";

  devices.forEach(device => {
    const option = document.createElement("option");
    option.value = device.id;
    option.text = device.label || "Camera";
    select.appendChild(option);
  });

  if (devices.length > 0) {
    currentCameraId = devices[0].id;
    startScanner(currentCameraId);
  }

  select.onchange = function() {
    currentCameraId = this.value;
    restartScanner();
  };
}

async function startScanner(cameraId) {
  scanner = new Html5Qrcode("reader");

  const config = {
    fps: 25,
    formatsToSupport: [
      Html5QrcodeSupportedFormats.EAN_13,
      Html5QrcodeSupportedFormats.EAN_8,
      Html5QrcodeSupportedFormats.CODE_128
    ],
    videoConstraints: {
      deviceId: { exact: cameraId },
      width: { ideal: 1280 },
      height: { ideal: 720 }
    },
    qrbox: function(w, h) {
      return {
        width: w * 0.95,
        height: 70
      };
    }
  };

  await scanner.start(
    { deviceId: { exact: cameraId }, advanced:[{torch:torchOn}] },
    config,
    onScanSuccess
  );

  document.getElementById("status").innerText =
    "‡πÄ‡∏•‡πá‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏ö | ‡∏´‡∏°‡∏∏‡∏ô‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î";
}

async function restartScanner() {
  if (scanner) {
    await scanner.stop();
    await scanner.clear();
  }
  startScanner(currentCameraId);
}

function onScanSuccess(decodedText) {
  navigator.vibrate?.(200);
  sendToChat(decodedText);
}

async function toggleTorch() {
  torchOn = !torchOn;
  restartScanner();
}

document.getElementById("zoomRange").addEventListener("input", async function() {
  const zoomValue = parseFloat(this.value);
  try {
    await scanner.applyVideoConstraints({
      advanced: [{ zoom: zoomValue }]
    });
  } catch(e){}
});

function sendManual() {
  const val = document.getElementById("manualInput").value.trim();
  if (val) sendToChat(val);
}

function sendToChat(text) {
  if (liff.isInClient()) {
    liff.sendMessages([{ type:"text", text:text }])
      .then(()=>liff.closeWindow());
  } else {
    alert(text);
  }
}

init();
</script>
</body>
</html>
