<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner - Leamchabang</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

<style>
body {
  font-family: sans-serif;
  background: #000;
  margin: 0;
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

header {
  background: #1A374D;
  color: white;
  padding: 15px;
  text-align: center;
}

#video-container {
  position: relative;
  flex: 1;
}

video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.scan-frame {
  position: absolute;
  width: 85%;
  height: 80px;
  border: 2px solid #fff;
  box-shadow: 0 0 0 9999px rgba(0,0,0,0.7);
  border-radius: 10px;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

.controls {
  background: #fff;
  padding: 15px;
  text-align: center;
}

#status {
  font-weight: bold;
}
</style>
</head>
<body>

<header>
  <h3>‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
</header>

<div id="video-container">
  <div class="scan-frame"></div>
  <video id="video" autoplay muted playsinline></video>
</div>

<div class="controls">
  <p id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...</p>
</div>

<script>

const LIFF_ID = "2008552223-7BjGxV6G";
let codeReader;
let isScanning = false;

// üî• ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡∏≠ permission ‡∏Å‡πà‡∏≠‡∏ô
async function requestCameraPermission() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });
    stream.getTracks().forEach(track => track.stop());
    return true;
  } catch (err) {
    return false;
  }
}

async function initLIFF() {
  try {
    await liff.init({ liffId: LIFF_ID });

    const allowed = await requestCameraPermission();

    if (!allowed) {
      document.getElementById('status').innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á";
      return;
    }

    startScanner();

  } catch (err) {
    document.getElementById('status').innerText = "LIFF Error";
  }
}

function startScanner() {

  const hints = new Map();
  hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
    ZXing.BarcodeFormat.EAN_13,
    ZXing.BarcodeFormat.CODE_128,
    ZXing.BarcodeFormat.EAN_8
  ]);
  hints.set(ZXing.DecodeHintType.TRY_HARDER, true);

  codeReader = new ZXing.BrowserBarcodeReader(hints);
  isScanning = true;

  codeReader.decodeFromConstraints(
    {
      video: {
        facingMode: { exact: "environment" }
      }
    },
    'video',
    (result, err) => {

      if (result && isScanning) {
        isScanning = false;
        playSound();
        sendMessage(result.text);
        codeReader.reset();
      }
    }
  );

  document.getElementById('status').innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô";
}

async function sendMessage(text) {

  if (!liff.isInClient()) {
    alert(text);
    return;
  }

  try {
    await liff.sendMessages([
      { type: 'text', text: text }
    ]);
    liff.closeWindow();
  } catch (err) {
    document.getElementById('status').innerText = "‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  }
}

function playSound() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.frequency.value = 1500;
  gain.gain.value = 0.1;
  osc.start();
  setTimeout(() => osc.stop(), 100);
}

initLIFF();

</script>
</body>
</html>
