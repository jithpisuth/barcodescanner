<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scanner</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>

<style>
body {
  margin: 0;
  background: black;
  overflow: hidden;
}
video {
  width: 100vw;
  height: 100vh;
  object-fit: cover;
}
#overlay {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 70%;
  height: 25%;
  transform: translate(-50%, -50%);
  border: 3px solid #00ff88;
  box-sizing: border-box;
}
</style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<div id="overlay"></div>
<input type="text" id="keyboardInput" autofocus style="opacity:0;position:absolute;">

<script>

const LIFF_ID = "2008552223-7BjGxV6G";
let codeReader;
let scanLock = false;

// ---------- Warmup (แก้ LINE WebView กล้องดำ) ----------
async function warmUpCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    stream.getTracks().forEach(t => t.stop());
  } catch (e) {}
}

// ---------- เลือกกล้องหลังปกติ ----------
function selectBackCamera(devices) {
  for (const device of devices) {
    const label = device.label.toLowerCase();
    if (
      (label.includes("back") || label.includes("rear")) &&
      !label.includes("wide") &&
      !label.includes("ultra") &&
      !label.includes("macro")
    ) {
      return device.deviceId;
    }
  }
  return devices[0]?.deviceId;
}

// ---------- ยิงแล้วส่ง ----------
async function sendResult(text) {
  if (scanLock) return;
  scanLock = true;

  // beep
  const audio = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAACJWAAACABAAZGF0YQAAAAA=");
  audio.play().catch(()=>{});

  // vibration
  if (navigator.vibrate) navigator.vibrate(150);

  try {
    await liff.sendMessages([
      { type: "text", text: text }
    ]);
  } catch (e) {}

  setTimeout(() => {
    liff.closeWindow();
  }, 200);
}

// ---------- กล้องสแกน ----------
async function startCameraScanner() {
  codeReader = new ZXing.BrowserMultiFormatReader();

  const devices = await codeReader.listVideoInputDevices();
  const selectedId = selectBackCamera(devices);

  codeReader.decodeFromVideoDevice(
    selectedId,
    "video",
    (result, err) => {
      if (result) {
        sendResult(result.getText());
      }
    }
  );

  // force continuous focus
  setTimeout(async () => {
    const video = document.querySelector("video");
    const stream = video.srcObject;
    if (!stream) return;

    const track = stream.getVideoTracks()[0];
    const caps = track.getCapabilities();
    const adv = {};

    if (caps.focusMode) adv.focusMode = "continuous";
    if (caps.exposureMode) adv.exposureMode = "continuous";

    if (Object.keys(adv).length > 0) {
      await track.applyConstraints({ advanced: [adv] });
    }
  }, 500);
}

// ---------- รองรับ Bluetooth Scanner ----------
function setupKeyboardScanner() {
  const input = document.getElementById("keyboardInput");
  input.focus();

  let buffer = "";

  input.addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      if (buffer.length > 5) {
        sendResult(buffer);
      }
      buffer = "";
    } else {
      buffer += e.key;
    }
  });
}

// ---------- Init ----------
async function init() {
  await liff.init({ liffId: LIFF_ID });

  await warmUpCamera();
  await startCameraScanner();
  setupKeyboardScanner();
}

init();

</script>
</body>
</html>
